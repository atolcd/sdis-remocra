#!/usr/bin/env groovy

pipeline {
  options {
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '10'))
  }
  agent {
    label 'release'
  }
  stages {
    stage('Build client-ng') {
      agent {
        docker {
          image 'node:10'
          args '-v "/var/lib/jenkins/.npmrc:/home/node/.npmrc:ro"'
          reuseNode true
        }
      }
      environment {
        NPM_CONFIG_CACHE = "${env.WORKSPACE}/.npm"
      }
      steps {
        dir('client-ng') {
          sh 'sed -i "s@https://registry.npmjs.org/@$(npm config get registry)@" package-lock.json'
          sh 'npm install'
          sh 'npm run build'
        }
      }
      post {
        always {
          sh 'rm -rf client-ng/node_modules/'
        }
      }
    }
    stage('Build remocra') {
      agent {
        docker {
          image 'cvagner/docker-jdk-maven-sencha-cmd:8-3.6.3-3.0.2'
          args '-v /var/lib/jenkins/.m2/settings.xml:/tmp/settings.xml:ro'
          reuseNode true
        }
      }
      environment {
        NEXUS_REPO = 'https://nexus3-ovh.priv.atolcd.com/repository/sdis-remocra/zip'
      }
      stages {
        stage("Clean") {
          steps {
            sh "mvn -e -Duser.home=${env.WORKSPACE} -s /tmp/settings.xml -U -ntp -Dskip.installnodenpm -Dskip.npm clean"
          }
        }
        stage("Build update") {
          when {
            expression {
              return env.BUILD_MODE == 'all' || env.BUILD_MODE == 'update';
            }
          }
          steps {
            sh "mvn -e -Duser.home=${env.WORKSPACE} -s /tmp/settings.xml -U -ntp -Dskip.installnodenpm -Dskip.npm verify -P modeinfo-able -P update"
          }
        }
        stage("Build install") {
          when {
            expression {
              return env.BUILD_MODE == 'all' || env.BUILD_MODE == 'install';
            }
          }
          steps {
            sh "mvn -e -Duser.home=${env.WORKSPACE} -s /tmp/settings.xml -U -ntp -Dskip.installnodenpm -Dskip.npm verify -P modeinfo-able -P install"
          }
        }
      }
    }
    post {
      success {
        // → Archivage
        archiveArtifacts allowEmptyArchive: false, artifacts: 'dist/target/*.zip', fingerprint: true
        // → Nexus
        withCredentials([usernameColonPassword(credentialsId: 'nexus3-jenkins', variable: 'NEXUS3_AUTH')]) {
          sh 'find dist/target -name *.zip -type f -exec basename {} \\; | xargs -I{} curl -v --user "$NEXUS3_AUTH" -T dist/target/{} "$NEXUS_REPO/{}"'
        }
      }
      always {
        sh "git checkout -- ."
      }
    }
  }
}
