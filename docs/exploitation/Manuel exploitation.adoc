= SDIS Remocra - Manuel d'exploitation

ifdef::env-github,env-browser[:outfilesuffix: .adoc]

:experimental:
:icons: font

:toc:

:numbered:

link:../index{outfilesuffix}[Retour à l'accueil]

'''

== Sauvegarde / Restauration

=== Sauvegarde

* *Fichiers*
** `/var/remocra` à l'exception de quelques fichiers générés

[source,sh]
----
# Estimation de la taille sur disque (fichiers non compressés)
du -sh /var/remocra \
  --exclude=/var/remocra/atlas \
  --exclude=/var/remocra/geoserver_data/logs \
  --exclude=/var/remocra/pdi/depot \
  --exclude=/var/remocra/pdi/export \
  --exclude=/var/remocra/pdi/log \
  --exclude=/var/remocra/pdi/synchro \
  --exclude=/var/remocra/pdi/tmp


# Sauvegarde
zip -rq /root/var_remocra.zip /var/remocra \
  -x /var/remocra/atlas/**\* \
  /var/remocra/geoserver_data/logs/*.log \
  /var/remocra/pdi/depot/**\* \
  /var/remocra/pdi/export/**\* \
  /var/remocra/pdi/log/**\* \
  /var/remocra/pdi/synchro/**\* \
  /var/remocra/pdi/tmp/**\*
# ➔ fichier /root/var_remocra.zip
----

* *Base de données*

Deux versions au choix :

[source,sh]
----
su postgres -c "/home/postgres/backup/backup_remocra_gzip.sh"
# ➔ fichier /home/postgres/backup/remocra_all.sql.gz

su postgres -c "/home/postgres/backup/backup_remocra.sh"
# ➔ fichier /home/postgres/backup/remocra_all.sql
----


=== Restauration

* *Fichiers*
** `/var/remocra`

[source,sh]
----
# Extraction
unzip -q /root/var_remocra.zip -d /
----

* *Base de données*

[source,sh]
----
cd /home/postgres/backup

# Extraction si nécessaire (sauvegarde réalisée avec `/home/postgres/backup/backup_remocra_gzip.sh`)
gunzip remocra_all.sql.gz && chown postgres:postgres remocra_all.sql

# Arrêt des services
service tomcat6 stop && service geoserver stop

# Remplacement de la base de données
su postgres -c "dropdb remocra && psql -d postgres -f /home/postgres/backup/remocra_all.sql 2>&1 | tee /home/postgres/backup/remocra_all.sql.log"

# Redémarrage des services
service tomcat6 start && service geoserver start && service httpd reload
----



== Tâches planifiées

Via http://www.linux-france.org/article/man-fr/man5/crontab-5.html[crontab], pour l'utilisateur `postgres` :

[source,sh]
----
# Lister les tâches planifiées
crontab -l -u postgres

# Editer les tâches planifiées
crontab -e -u postgres

----

== Services système

Manipulation des services disponibles :

[source,sh]
----
# PostgeSQL
service postgresql status
service postgresql start
service postgresql stop
service postgresql restart

# Tomcat
service tomcat6 status
service tomcat6 start
service tomcat6 stop
service tomcat6 restart

# GeoServer
service geoserver status
service geoserver start
service geoserver stop
service geoserver restart

# Apache HTTPD
service httpd status
service httpd start
service httpd stop
service httpd restart
service httpd reload
----


== Journaux

=== Localisation des journaux

Les fichiers journaux intéressants sont les suivants.

* *PostgreSQL*
** /var/lib/pgsql/data/pg_log/postgresql-Mon.log
** /var/lib/pgsql/data/pg_log/postgresql-Tue.log
** /var/lib/pgsql/data/pg_log/postgresql-Wed.log
** /var/lib/pgsql/data/pg_log/postgresql-Thu.log
** /var/lib/pgsql/data/pg_log/postgresql-Fri.log
** /var/lib/pgsql/data/pg_log/postgresql-Sat.log
** /var/lib/pgsql/data/pg_log/postgresql-Sun.log

* *Tomcat (remocra)*
** /var/log/tomcat6-initd.log : démarrage du service
** /var/log/tomcat6/catalina.out

* *GeoServer*
** /var/log/geoserver-initd.log : démarrage du service
** /var/remocra/geoserver_data/logs/geoserver.log

* *Apache HTTPD*
** /var/log/httpd/remocra_access.log
** /var/log/httpd/remocra_error.log

=== Configuration de la rotation

*PostgreSQL*

* Rotation prise en charge par https://www.postgresql.org/docs/8.4/runtime-config-logging.html[PostgreSQL]

[source,sh]
----
# Rotation des journaux de PostgreSQL
cat /var/lib/pgsql/data/postgresql.conf | grep log_

# Résultat ↴↴↴
log_filename = 'postgresql-%a.log' # log file name pattern,
log_truncate_on_rotation = on # If on, an existing log file of the
log_rotation_age = 1d
----


*Tomcat*

* Rotation prise en charge par https://linux.die.net/man/8/logrotate[logrotate]

[source,sh]
----
# Journalisation de Tomcat
cat /usr/share/tomcat6/conf/logging.properties

# Rotation des journaux de Tomcat
cat /etc/logrotate.d/tomcat6

# Résultat ↴↴↴
/var/log/tomcat6/catalina.out {
    copytruncate
    weekly
    rotate 52
    compress
    missingok
    create 0644 tomcat tomcat
}
----


*GeoServer*

* Rotation prise en charge par https://docs.geoserver.org/stable/en/user/configuration/globalsettings.html#logging-profile[GeoServer]

[source,sh]
----
# Profil de journalisation
cat /var/remocra/geoserver_data/logging.xml | grep level

# Résultat ↴↴↴
<level>VERBOSE_LOGGING.properties</level>

# Exemple avec le profil "VERBOSE_LOGGING"
cat /var/remocra/geoserver_data/logs/VERBOSE_LOGGING.properties | grep RollingFileAppender

# Résultat ↴↴↴
log4j.appender.geoserverlogfile=org.apache.log4j.RollingFileAppender
----



*Apache HTTPD*

* Rotation prise en charge par https://linux.die.net/man/8/logrotate[logrotate]

[source,sh]
----
# Rotation des journaux d'Apache HTTPD
cat /etc/logrotate.d/httpd

# Résultat ↴↴↴
/var/log/httpd/*log {
    missingok
    notifempty
    sharedscripts
    delaycompress
    postrotate
        /sbin/service httpd reload > /dev/null 2>/dev/null || true
    endscript
}
----



*Pentaho Data Integration*

* Nettoyage des fichiers .TXT` produits :
[source,sh]
----
crontab -l -u postgres | grep -B1 ".TXT"

# Résultat ↴↴↴
# Nettoyage des fichiers produits par les traitements PDI
50 23 * * * find /var/remocra/pdi/log/ -mtime +7 -name "*.TXT" -print -exec rm {} \;
----

* Rotation prise en charge par https://linux.die.net/man/8/logrotate[logrotate]

[source,sh]
----
# Rotation des journaux de PDI
cat /etc/logrotate.d/remocra_pdi

# Résultat ↴↴↴
/var/remocra/pdi/log/*log {
    copytruncate
    daily
    rotate 7
    compress
    missingok
    create 0770 postgres remocrasys
}
----



== Accès aux bases de données PostgreSQL

Cf. https://docs.postgresql.fr/8.4/client-authentication.html[documentation PostgreSQL].

Mettre à jour la valeur de `listen_addresses` :

./var/lib/pgsql/data/postgresql.conf
[source,sh]
----
listen_addresses = '*'
----

Ajouter les adresses IP ou plages d'adresses à autoriser (exemple) :

./var/lib/pgsql/data/pg_hba.conf
[source,sh]
----
local all     all                     ident
host  all     all      127.0.0.1/32   md5
host  all     all      ::1/128        md5
host  remocra postgres 192.168.1.5/32 md5
----

[source,sh]
----
service postgresql reload
----
